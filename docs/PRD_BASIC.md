# QMT Weight Sync 产品需求文档 (PRD)

## 1. 项目概览

### 1.1 项目名称
**QMT Weight Sync (自动权重调仓系统)**

### 1.2 背景与目标
本项目旨在为量化交易者提供一个轻量级、独立的自动调仓工具。它基于 Python 的 Streamlit 框架作为前端，通过 `xtquant` 库连接 MiniQMT 交易终端，实现从“持仓权重文件”到“实盘交易执行”的自动化流程。

核心目标是解决手动计算股数、手动下单繁琐且容易出错的问题，同时提供基本的账户监控和收益回测功能。

### 1.3 适用场景
- 每日盘前更新策略目标仓位。
- 需要将策略输出（CSV/Excel）快速转换为实盘持仓。
- 依赖 MiniQMT 进行 A 股实盘交易。

---

## 2. 产品功能

### 2.1 Web 操作界面
采用 Streamlit 构建响应式 Web 界面，包含以下模块：
*   **登录验证**：简单的密码保护机制，防止误操作。
*   **仪表盘**：直观展示核心状态（调度器状态、账户概览）。
*   **交互操作**：支持文件上传、手动刷新数据、手动触发调仓计算。

### 2.2 核心业务功能

#### 2.2.1 持仓文件管理
*   **文件上传**：支持 `.xlsx`, `.xls`, `.csv` 格式。
*   **数据解析**：自动识别 `date` (日期), `stock_code` (证券代码), `weight` (目标权重)。
*   **数据校验**：
    *   过滤非 A 股代码（仅保留 .SH, .SZ）。
    *   过滤无效权重（如负数）。
    *   校验交易日。
*   **数据存储**：解析后的标准化数据存储为 Parquet 文件，便于历史追溯。

#### 2.2.2 账户与持仓监控
*   **实时资产**：展示总资产、可用资金、持仓市值、冻结资金。
*   **实时持仓**：展示当前账户的持仓明细（股数、市值、盈亏）。
*   **收益曲线**：
    *   记录每日账户总资产。
    *   自动拉取上证指数作为基准。
    *   绘制账户收益率 vs 上证指数收益率对比图，计算超额收益。

#### 2.2.3 智能调仓执行
*   **目标股数计算**：
    *   `目标市值 = 账户总资产 × 目标权重`
    *   `目标股数 = 目标市值 / 实时卖三价`
    *   **取整规则**：严格四舍五入到 100 股（手）。
*   **交易执行算法**：
    1.  **差异计算**：对比当前持仓与目标持仓，生成“买入清单”和“卖出清单”。
    2.  **先卖后买**：优先执行卖出操作，释放资金。
    3.  **成交等待**：在卖出指令下达后，轮询检查直至全部成交（或超时），再执行买入。
    4.  **激进报价**：
        *   卖出：使用**买五价** (Bid Price 5) 确保快速成交。
        *   买入：使用**卖三价** (Ask Price 3) 确保快速成交。

### 2.3 自动化调度
*   **定时任务**：后台自动运行，默认配置在每个交易日的特定时间（如 09:25）触发调仓。
*   **双进程架构**：Streamlit Web 服务与调度服务分离，确保界面关闭不影响后台任务执行。

---

## 3. 技术方案与实现

### 3.1 技术栈
*   **语言**：Python 3.10+
*   **包管理**：`uv` (高性能 Python 包管理器)
*   **前端框架**：`Streamlit`
*   **交易接口**：`xtquant` (MiniQMT 官方 Python SDK)
*   **数据处理**：`pandas`, `numpy`, `pyarrow`
*   **图表库**：`plotly`
*   **调度库**：`schedule`

### 3.2 系统架构

```mermaid
graph TD
    User[用户] --> |上传/操作| WebUI[Streamlit Web 界面]
    WebUI --> |读取/写入| FS[文件系统 (Parquet/Logs)]
    WebUI --> |请求| Trader[交易核心模块]
    
    Scheduler[调度服务] --> |定时触发| Trader
    
    Trader --> |Connect/Order| MiniQMT[MiniQMT 客户端]
    MiniQMT --> |Order/Asset| Exchange[交易所/券商]
```

### 3.3 关键实现细节

#### A. 交易执行类 (`QMTWeightSyncTrader`)
封装了 `XtQuantTrader`，实现了连接保持、断线重连、以及核心的“计算-下单-等待”状态机逻辑。通过 `queue_orders` 或直接循环调用 `order_stock` 批量下单。

#### B. 数据流
1.  **输入**：用户上传 Excel -> `TEMP_DIR` -> `pandas解析` -> `Parquet存储`。
2.  **执行**：读取 Parquet (最新目标) + 读取 QMT (当前持仓) -> 计算 Diff -> 生成 Orders。
3.  **记录**：每日收盘后记录 Total Asset -> `account_history.csv` -> 前端绘图。

#### C. 安全性
*   配置与代码分离：敏感信息（账户ID、密码）存储在 `config.py` 或环境变量。
*   交易保护：下单价格使用限价单（Fix Price）而非市价单，避免极端行情下的滑点风险。

---

## 4. 部署与运行

### 4.1 环境要求
*   Windows 操作系统 (MiniQMT 限制)。
*   安装并登录 MiniQMT 客户端（极简模式）。
*   Python 环境安装依赖 (`pyproject.toml`)。

### 4.2 运行方式
1.  启动 Web 界面：
    ```bash
    uv run streamlit run app.py --server.port 19210
    ```
2.  启动调度服务（可选，若需自动运行）：
    ```bash
    uv run python scheduler_service.py
    ```

---

## 5. 风险提示
*   本系统依赖 MiniQMT 客户端的本地运行，客户端崩溃或网络断开将导致无法交易。
*   “先卖后买”逻辑依赖卖单的及时成交，若卖单通过限价单无法成交，后续买单可能因资金不足而失败。
*   数据源依赖 `xtquant` 获取行情，需确保行情服务连接正常。
